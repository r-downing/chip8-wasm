<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <style>
        body {
            background-color: black;
            color: white;
            box-sizing: border-box;
            margin: 0;
            padding: 2em;
            width: 100%;
        }

        #canvas {
            border: 1px dotted lime;
            display: block;
            margin: auto;
        }
    </style>
</head>

<body>

    <!-- Create the canvas that the C++ code will draw into -->
    <canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>
    <br />
    <button id="startbutton">start</button>
    <br />
    <input type="file" id="fileloader" onchange="open_file(event)" />
    <pre id="stdout"></pre>
    <!-- <br /> -->
    <!-- <textarea id="output" rows="8"></textarea> -->


    <!-- Allow the C++ to access the canvas element -->
    <script type='text/javascript'>
        const stdout = document.querySelector("#stdout");
        stdout.textContent += "STDOUT:\n";
        var Module = {
            canvas: document.getElementById('canvas'),
            print: (str) => { stdout.textContent += str + "\n"; }
        };

        chip8_load_rom = (array_buffer) => {
            const uint8Arr = new Uint8Array(array_buffer);
            const num_bytes = uint8Arr.length * uint8Arr.BYTES_PER_ELEMENT;
            const data_ptr = Module._malloc(num_bytes);
            const data_on_heap = new Uint8Array(Module.HEAPU8.buffer, data_ptr, num_bytes);
            data_on_heap.set(uint8Arr);
            console.log("num_bytes");
            console.log(num_bytes);
            const res = Module.ccall('jscallback', 'number', ['number', 'number'], [data_on_heap.byteOffset, uint8Arr.length]);
            // console.log("res " + res);
            if (res) {
                document.querySelector("#fileloader").style.display = "none";
            }
            Module._free(data_ptr);
        };

        let button = document.querySelector("#startbutton");
        button.onclick = () => {
            fetch("assets/tetris_reassembled.ch8")
                .then((response) => response.arrayBuffer())
                .then((buf) => {

                    const uint8Arr = new Uint8Array(buf);
                    const num_bytes = uint8Arr.length * uint8Arr.BYTES_PER_ELEMENT;
                    const data_ptr = Module._malloc(num_bytes);
                    const data_on_heap = new Uint8Array(Module.HEAPU8.buffer, data_ptr, num_bytes);
                    data_on_heap.set(uint8Arr);
                    console.log("num_bytes");
                    console.log(num_bytes);
                    const res = Module.ccall('jscallback', 'number', ['number', 'number'], [data_on_heap.byteOffset, uint8Arr.length]);
                    Module._free(data_ptr);
                });
        }


        const open_file = function (e) {
            const file_reader = new FileReader();
            file_reader.onload = (event) => {
                chip8_load_rom(event.target.result);
                // const uint8Arr = new Uint8Array(event.target.result);
                // const num_bytes = uint8Arr.length * uint8Arr.BYTES_PER_ELEMENT;
                // const data_ptr = Module._malloc(num_bytes);
                // const data_on_heap = new Uint8Array(Module.HEAPU8.buffer, data_ptr, num_bytes);
                // data_on_heap.set(uint8Arr);
                // console.log("num_bytes");
                // console.log(num_bytes);
                // const res = Module.ccall('jscallback', 'number', ['number', 'number'], [data_on_heap.byteOffset, uint8Arr.length]);
                // Module._free(data_ptr);
            };
            file_reader.readAsArrayBuffer(e.target.files[0]);
        };

    </script>
    {{{ SCRIPT }}}
</body>

</html>